<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Star Citizen Ship Guessing Game</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/babel-standalone@7/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const App = () => {
      const [ships, setShips] = useState([]);
      const [shipImages, setShipImages] = useState([]);
      const [selectedShip, setSelectedShip] = useState(null);
      const [possibleShips, setPossibleShips] = useState([]);
      const [feedback, setFeedback] = useState({
        manufacturer: null,
        roles: null,
        length: null,
        price: null,
        cargo: null,
        crew: null,
        releaseYear: null,
      });
      const [error, setError] = useState(null);
      const [inputValue, setInputValue] = useState('');
      const [isLoading, setIsLoading] = useState(true);

      // Fetch ship list and images on mount
      useEffect(() => {
        const fetchData = async () => {
          setIsLoading(true);
          try {
            // Fetch ship list
            const shipResponse = await fetch('https://raw.githubusercontent.com/xavpitz/stardolver/refs/heads/main/stardolver_shiplist.json');
            if (!shipResponse.ok) throw new Error(`Failed to fetch ship list: ${shipResponse.statusText}`);
            const shipData = await shipResponse.json();
            setShips(shipData);
            setPossibleShips(shipData);

            // Fetch ship images
            const imageResponse = await fetch('https://api.starcitizen-api.com/e44a1e3a5d20293b6977bb7007872e64/v1/auto/ships');
            if (!imageResponse.ok) throw new Error(`Failed to fetch ship images: ${imageResponse.statusText}`);
            const imageData = await imageResponse.json();
            setShipImages(imageData.data || []);
          } catch (err) {
            setError(`Error loading data: ${err.message}. Please try running this on a local server (e.g., 'python -m http.server') and refresh.`);
          } finally {
            setIsLoading(false);
          }
        };
        fetchData();
      }, []);

      // Select a random ship
      const selectRandomShip = () => {
        if (ships.length === 0) {
          setError('No ships loaded yet');
          return;
        }
        const randomIndex = Math.floor(Math.random() * ships.length);
        setSelectedShip(ships[randomIndex]);
        setInputValue(ships[randomIndex].shipName);
      };

      // Handle feedback change
      const handleFeedbackChange = (key, value) => {
        setFeedback((prev) => ({ ...prev, [key]: value }));
      };

      // Submit feedback and filter possible ships
      const submitFeedback = () => {
        if (!selectedShip) {
          setError('Please select a ship first');
          return;
        }
        if (Object.values(feedback).some((v) => v === null)) {
          setError('Please provide feedback for all fields');
          return;
        }

        const newPossibleShips = possibleShips.filter((ship) => {
          try {
            // Manufacturer feedback
            if (feedback.manufacturer === 'correct' && ship.manufacturer !== selectedShip.manufacturer) return false;
            if (feedback.manufacturer === 'incorrect' && ship.manufacturer === selectedShip.manufacturer) return false;

            // Roles feedback
            if (feedback.roles === 'correct') {
              if (ship.roles.length !== selectedShip.roles.length) return false;
              if (!ship.roles.every((role) => selectedShip.roles.includes(role))) return false;
            }
            if (feedback.roles === 'incorrect' && ship.roles.every((role) => selectedShip.roles.includes(role)) && ship.roles.length === selectedShip.roles.length) return false;

            // Numerical attributes
            const numericalChecks = [
              { key: 'length', value: parseFloat(ship.length), compare: parseFloat(selectedShip.length) },
              { key: 'price', value: parseFloat(ship.price[0]), compare: parseFloat(selectedShip.price[0]) },
              { key: 'cargo', value: parseFloat(ship.cargo), compare: parseFloat(selectedShip.cargo) },
              { key: 'crew', value: parseInt(ship.crew), compare: parseInt(selectedShip.crew) },
              { key: 'releaseYear', value: parseInt(ship.releaseYear), compare: parseInt(selectedShip.releaseYear) },
            ];

            return numericalChecks.every(({ key, value, compare }) => {
              if (feedback[key] === 'correct') return value === compare;
              if (feedback[key] === 'less') return value < compare;
              if (feedback[key] === 'greater') return value > compare;
              return true;
            });
          } catch (err) {
            console.error(`Error filtering ship ${ship.shipName}: ${err.message}`);
            return false; // Exclude ships that cause errors
          }
        });

        setPossibleShips(newPossibleShips);
        setError(null);
        setFeedback({
          manufacturer: null,
          roles: null,
          length: null,
          price: null,
          cargo: null,
          crew: null,
          releaseYear: null,
        });
        setInputValue('');
        setSelectedShip(null);
      };

      // Get ship image URLs
      const getShipImage = (ship) => {
        const apiShip = shipImages.find((imgShip) => {
          const manufacturerMap = {
            'Origin': 'ORIG',
            'Crusader': 'CRSD',
            'RSI': 'RSI',
            'Anvil': 'ANVL',
            'Aegis': 'AEGS',
            'Drake': 'DRAK',
            'Esperia': 'ESPR',
            'Banu': 'BANU',
            'MISC': 'MISC',
            'Aopoa': 'AOPO',
            'Consolidated Outland': 'CNOU',
            'Argo': 'ARGO',
            'Mirai': 'MRAI',
            'Greycat': 'GRIN',
            'Tumbril': 'TMBL',
            'Gatac': 'GATX',
            'Kruger': 'KRGR',
          };
          return imgShip.manufacturer?.code === manufacturerMap[ship.manufacturer] && imgShip.name.toLowerCase() === ship.shipName.toLowerCase();
        });
        return {
          avatar: apiShip?.media?.[0]?.images?.avatar || '',
          large: apiShip?.media?.[0]?.source_url || '',
        };
      };

      if (isLoading) {
        return (
          <div className="container mx-auto p-4 text-center">
            <h1 className="text-3xl font-bold mb-4">Loading...</h1>
            <p>Please wait while the ship data is being fetched.</p>
          </div>
        );
      }

      if (error) {
        return (
          <div className="container mx-auto p-4 text-center">
            <h1 className="text-3xl font-bold mb-4">Star Citizen Ship Guessing Game</h1>
            <p className="text-red-500 mb-4">{error}</p>
            <p>Try running this file on a local server:</p>
            <pre className="bg-gray-800 p-4 rounded">
              python -m http.server 8000
            </pre>
            <p>Then visit <a href="http://localhost:8000" className="text-blue-400">http://localhost:8000</a></p>
          </div>
        );
      }

      return (
        <div className="container mx-auto p-4">
          <h1 className="text-3xl font-bold mb-4 text-center">Star Citizen Ship Guessing Game</h1>

          {/* Ship Selection */}
          <div className="mb-6">
            <h2 className="text-xl font-semibold mb-2">Select a Ship</h2>
            <div className="flex gap-2">
              <input
                type="text"
                list="shipNames"
                value={inputValue}
                onChange={(e) => {
                  setInputValue(e.target.value);
                  const ship = ships.find((s) => s.shipName.toLowerCase() === e.target.value.toLowerCase());
                  setSelectedShip(ship || null);
                }}
                placeholder="Type ship name..."
                className="p-2 bg-gray-800 border border-gray-700 rounded w-full text-white"
              />
              <datalist id="shipNames">
                {ships.map((ship) => (
                  <option key={ship.id} value={ship.shipName} />
                ))}
              </datalist>
              <button
                onClick={selectRandomShip}
                className="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded"
              >
                Random Ship
              </button>
            </div>
            {selectedShip && (
              <div className="mt-2">
                <p><strong>Selected Ship:</strong> {selectedShip.shipName}</p>
                <p><strong>Manufacturer:</strong> {selectedShip.manufacturer}</p>
                <p><strong>Roles:</strong> {selectedShip.roles.join(', ')}</p>
                <p><strong>Length:</strong> {selectedShip.length} m</p>
                <p><strong>Price:</strong> ${selectedShip.price[0]}</p>
                <p><strong>Cargo:</strong> {selectedShip.cargo} SCU</p>
                <p><strong>Crew:</strong> {selectedShip.crew}</p>
                <p><strong>Release Year:</strong> {selectedShip.releaseYear}</p>
              </div>
            )}
          </div>

          {/* Feedback Form */}
          {selectedShip && (
            <div className="mb-6">
              <h2 className="text-xl font-semibold mb-2">Provide Feedback</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {/* Manufacturer Feedback */}
                <div>
                  <p><strong>Manufacturer Correct?</strong></p>
                  <label className="mr-4">
                    <input
                      type="radio"
                      name="manufacturer"
                      value="correct"
                      checked={feedback.manufacturer === 'correct'}
                      onChange={() => handleFeedbackChange('manufacturer', 'correct')}
                      className="mr-1"
                    />
                    Correct
                  </label>
                  <label>
                    <input
                      type="radio"
                      name="manufacturer"
                      value="incorrect"
                      checked={feedback.manufacturer === 'incorrect'}
                      onChange={() => handleFeedbackChange('manufacturer', 'incorrect')}
                      className="mr-1"
                    />
                    Incorrect
                  </label>
                </div>

                {/* Roles Feedback */}
                <div>
                  <p><strong>Roles Correct?</strong></p>
                  <label className="mr-4">
                    <input
                      type="radio"
                      name="roles"
                      value="correct"
                      checked={feedback.roles === 'correct'}
                      onChange={() => handleFeedbackChange('roles', 'correct')}
                      className="mr-1"
                    />
                    Correct
                  </label>
                  <label>
                    <input
                      type="radio"
                      name="roles"
                      value="incorrect"
                      checked={feedback.roles === 'incorrect'}
                      onChange={() => handleFeedbackChange('roles', 'incorrect')}
                      className="mr-1"
                    />
                    Incorrect
                  </label>
                </div>

                {/* Numerical Feedback */}
                {['length', 'price', 'cargo', 'crew', 'releaseYear'].map((attr) => (
                  <div key={attr}>
                    <p><strong>{attr.charAt(0).toUpperCase() + attr.slice(1)} Feedback</strong></p>
                    <select
                      value={feedback[attr] || ''}
                      onChange={(e) => handleFeedbackChange(attr, e.target.value)}
                      className="p-2 bg-gray-800 border border-gray-700 rounded w-full text-white"
                    >
                      <option value="">Select...</option>
                      <option value="correct">Correct</option>
                      <option value="less">Less Than</option>
                      <option value="greater">Greater Than</option>
                    </select>
                  </div>
                ))}
              </div>
              <button
                onClick={submitFeedback}
                className="mt-4 px-4 py-2 bg-green-600 hover:bg-green-700 rounded"
              >
                Submit Feedback
              </button>
            </div>
          )}

          {/* Remaining Ships */}
          <div>
            <h2 className="text-xl font-semibold mb-2">Possible Remaining Ships ({possibleShips.length})</h2>
            {possibleShips.length === 0 && !selectedShip && (
              <p>No ships match the criteria. Try resetting or selecting a new ship.</p>
            )}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {possibleShips.map((ship) => {
                const images = getShipImage(ship);
                return (
                  <div key={ship.id} className="p-4 bg-gray-800 rounded flex items-start">
                    {images.avatar && (
                      <img
                        src={images.avatar}
                        alt={ship.shipName}
                        className="w-16 h-16 object-cover mr-4 rounded"
                        onError={(e) => (e.target.style.display = 'none')}
                      />
                    )}
                    <div>
                      <p><strong>{ship.shipName}</strong></p>
                      <p>Manufacturer: {ship.manufacturer}</p>
                      <p>Roles: {ship.roles.join(', ')}</p>
                      <p>Length: {ship.length} m</p>
                      <p>Price: ${ship.price[0]}</p>
                      <p>Cargo: {ship.cargo} SCU</p>
                      <p>Crew: {ship.crew}</p>
                      <p>Release Year: {ship.releaseYear}</p>
                      {images.large && (
                        <a href={images.large} target="_blank" className="text-blue-400 hover:underline">
                          View Large Image
                        </a>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      );
    };

    try {
      ReactDOM.render(<App />, document.getElementById('root'));
    } catch (err) {
      document.getElementById('root').innerHTML = `
        <div class="container mx-auto p-4 text-center">
          <h1 class="text-3xl font-bold mb-4">Error</h1>
          <p class="text-red-500">Failed to render application: ${err.message}</p>
          <p>Please check the browser console (F12) for details and ensure you're running on a local server.</p>
        </div>
      `;
    }
  </script>
</body>
</html>